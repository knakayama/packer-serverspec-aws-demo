machine:
  environment:
    PACKER_VER: 0.8.6
    PACKER_BIN_PATH: ~/.packer
    PATH: $PACKER_BIN_PATH:$PATH

dependencies:
  cache_directories:
    - ~/.packer
    - ~/.packer.d/plugins

  pre:
    - |
      if [[ -z "$(ls -A ~/.packer)" ]]; then
        [[ -d ~/.packer ]] || mkdir ~/.packer
        cd ~/.packer
        wget "https://releases.hashicorp.com/packer/${PACKER_VER}/packer_${PACKER_VER}_linux_amd64.zip"
        unzip *.zip
        rm *.zip
      fi

      if [[ -z "$(ls -A ~/.packer.d/plugins)" ]]; then
        [[ -d ~/.packer.d/plugins ]] || mkdir -p ~/.packer.d/plugins
        go get github.com/udzura/packer-provisioner-serverspec
        go get github.com/hashicorp/yamux
        go get github.com/ugorji/go/codec
        cd ~/.go_workspace/src/github.com/udzura/packer-provisioner-serverspec
        go build ./cmd/packer-provisioner-serverspec
        cp -pv ./packer-provisioner-serverspec ~/.packer.d/plugins
      fi

  override:
    - echo "TODO build"

test:
  override:
    - |
      cd packer/aws/Amazon_Linux
      packer validate web.json

deployment:
  production:
    branch: master
    commands:
      - |
        cd packer/aws/Amazon_Linux
        packer build web.json
